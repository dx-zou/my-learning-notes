<!DOCTYPE html>
<html lang="en">
  <head>
    <title></title>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width,user-scalable=no,initial-scale=1"
    />
    <script src=""></script>
    <style>
      .container {
        width: 600px;
        margin: 0 auto;
      }

      .wrap {
        margin-bottom: 60px;
      }

      img {
        display: block;
        width: 600px;
        height: 300px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="wrap">
        <img class="test-img" alt="loading" data-src="./images/1.jpg" />
      </div>
      <div class="wrap">
        <img class="test-img" alt="loading" data-src="./images/2.jpg" />
      </div>
      <div class="wrap">
        <img class="test-img" alt="loading" data-src="./images/3.jpg" />
      </div>
      <div class="wrap">
        <img class="test-img" alt="loading" data-src="./images/4.jpg" />
      </div>
      <div class="wrap">
        <img class="test-img" alt="loading" data-src="./images/5.png" />
      </div>
      <div class="wrap">
        <img class="test-img" alt="loading" data-src="./images/6.jpg" />
      </div>
      <div class="wrap">
        <img class="test-img" alt="loading" data-src="./images/7.jpg" />
      </div>
      <div class="wrap">
        <img class="test-img" alt="loading" data-src="./images/8.jpg" />
      </div>
    </div>
    <script>
      window.onload = function() {
        // var flag = false;
        checkImgs();
        // window.onscroll = throttle(checkImgs, 300);
        window.onscroll = throttle3(checkImgs, 300);
        //遍历图片是否在可视区，if true 则加载
        function checkImgs() {
          // if (flag) return;
          const allImgs = document.querySelectorAll(".test-img");
          //过滤出没有加载的图片
          const noLoading = Array.from(allImgs).filter(item => !item.index);
          // if (noLoading.length === 0) return (flag = true);
          noLoading.forEach(el => {
            if (isInSight(el)) {
              loadImg(el);
              //如果已经加载就标记一下
              el.index = 1;
            }
          });
        }
        // 判断图片是否在可视区
        function isInSight(el) {
          var rect = el.getBoundingClientRect();
          var height = window.innerHeight;
          return rect.top < height - 200;
        }
        //加载图片
        function loadImg(el) {
          if (!el.src) {
            el.src = el.dataset.src;
          }
        }
        //节流函数
        //时间戳方式
        function throttle(func, wait) {
          var context, args;
          var previous = 0;
          return function() {
            var now = +new Date();
            context = this;
            args = arguments;
            if (now - previous > wait) {
              func.apply(context, args);
              console.log("run");

              previous = now;
            }
          };
        }
        //定时器方式
        function throttle2(func, wait) {
          var timeout;
          return function() {
            var that = this;
            var args = arguments;
            if (!timeout) {
              timeout = setTimeout(function() {
                timeout = null;
                // func();
                func.apply(that, args);
                console.log("run");
              }, wait);
            }
          };
        }
        function throttle3(func, wait) {
          var timeout;
          return function() {
            if (!timeout) {
              timeout = setTimeout(() => {
                timeout = null;
                func();
                console.log("run");
              }, wait);
            }
          };
        }
      };
    </script>
  </body>
</html>
